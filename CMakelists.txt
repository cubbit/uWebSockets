# Setting requirements
cmake_minimum_required(VERSION 3.9.2)
include(ExternalProject)
include(GNUInstallDirs)

set(CMAKE_CXX_STANDARD 17)

# Project settings
set(PROJECT_NAME uws)
project(${PROJECT_NAME} CXX C)
set(CMAKE_MODULE_PATH ${CMAKE_MODULE_PATH} ${CMAKE_CURRENT_SOURCE_DIR}/cmake)

# Dependencies
set(CMAKE_THREAD_PREFER_PTHREAD TRUE)
set(THREADS_PREFER_PTHREAD_FLAG TRUE)
find_package(Threads REQUIRED)
find_package(LibUV REQUIRED)
find_package(ZLIB REQUIRED)
find_package(OpenSSL REQUIRED)

file(GLOB_RECURSE USOCKETS_HEADERS "${PROJECT_SOURCE_DIR}/uSockets/src/*.h*")
file(GLOB_RECURSE UWS_HEADERS "${PROJECT_SOURCE_DIR}/src/*.h*")

file(GLOB_RECURSE USOCKETS_SOURCES "${PROJECT_SOURCE_DIR}/uSockets/*.c")

add_library(${PROJECT_NAME} STATIC ${USOCKETS_SOURCES})
include_directories(${PROJECT_NAME} PUBLIC src uSockets/src)
include_directories(${PROJECT_NAME} PRIVATE 
    ${LibUV_INCLUDE_DIRS}
    ${ZLIB_INCLUDE_DIRS}
    ${OPENSSL_INCLUDE_DIR}
)

target_link_libraries(${PROJECT_NAME} 
    Threads::Threads
    ${LibUV_LIBRARIES}
    ${ZLIB_LIBRARIES}
    ${OpenSSL_LIBRARIES}
)

# Install
install(TARGETS ${PROJECT_NAME}
    EXPORT ${PROJECT_NAME}-targets
    LIBRARY DESTINATION ${CMAKE_INSTALL_LIBDIR}
    ARCHIVE DESTINATION  ${CMAKE_INSTALL_LIBDIR}
    INCLUDES DESTINATION ${CMAKE_INSTALL_INCLUDEDIR}
)

foreach (FILE ${UWS_HEADERS} )
    get_filename_component(DIR ${FILE} DIRECTORY)
    install(FILES ${FILE} DESTINATION ${CMAKE_INSTALL_INCLUDEDIR}/${PROJECT_NAME}/${DIR} )
endforeach()

# install(FILES 
#     # ${USOCKETS_HEADERS} DESTINATION ${CMAKE_INSTALL_INCLUDEDIR}/${PROJECT_NAME}
#     ${UWS_HEADERS} DESTINATION ${CMAKE_INSTALL_INCLUDEDIR}/${PROJECT_NAME}
# )
